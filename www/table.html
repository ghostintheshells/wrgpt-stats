<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Table</title>

    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap-grid.min.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap-reboot.min.css">

    <link rel="stylesheet" href="node_modules/chosen-jquery/lib/chosen.min.css">
</head>
<body>

<nav class="navbar navbar-default">
    <p class="navbar-text"><span id="playerName"></span></p>
    <form class="navbar-form navbar-left" role="search" id="playerSearchForm">
        <div class="form-group">
            <select id="allPlayers" multiple name="players"></select>
        </div>
        <button type="submit" class="btn btn-default">Submit</button>
    </form>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <table class="table" id="playerStats">
                <tr>
                    <th>Name</th>
                    <th>See flop %</th>
                    <th>Voluntary Put Money In Pot %</th>
                    <th>Pre-flop Raise %</th>
                    <th>Aggression Factor</th>
                    <th>Showdown (after flop) %</th>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <h3>Times Active</h3>
            <canvas id="activeTimesChart" width="400" height="400"></canvas>
        </div>
    </div>
</div>


<script src="node_modules/jquery/dist/jquery.min.js"></script>
<script src="node_modules/chosen-jquery/lib/chosen.jquery.min.js"></script>
<script src="node_modules/chart.js/dist/Chart.bundle.min.js"></script>
<script src="node_modules/chartjs-plugin-labels/build/chartjs-plugin-labels.min.js"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script>

    var ctx = document.getElementById("activeTimesChart").getContext('2d');
    var activeTimesChart = new Chart(ctx, {
        type: 'radar',
        data : {
            labels: [
                '0:00',
                '1:00',
                '2:00',
                '3:00',
                '4:00',
                '5:00',
                '6:00',
                '7:00',
                '8:00',
                '9:00',
                '10:00',
                '11:00',
                '12:00',
                '13:00',
                '14:00',
                '15:00',
                '16:00',
                '17:00',
                '18:00',
                '19:00',
                '20:00',
                '21:00',
                '22:00',
                '23:00',
            ],
            datasets: []
        },
    });

    const query = new URLSearchParams(location.search);

    const players = query.get('players').split(',');

    let colors = [
        "rgba(100,0,0,0.2)",
        "rgba(200,0,0,0.2)",
        "rgba(0,100,0,0.2)",
        "rgba(0,200,0,0.2)",
        "rgba(0,0,100,0.2)",
        "rgba(100,0,100,0.2)",
        "rgba(100,0,200,0.2)",
        "rgba(200,0,100,0.2)",
        "rgba(200,0,200,0.2)",
        "rgba(100,100,0,0.2)",
        "rgba(100,200,0,0.2)",
        "rgba(200,100,0,0.2)",
        "rgba(200,200,0,0.2)",
    ];

    players.forEach(function(player) {
        fetch('player.php?player=' + player).then(function(res) {
            return res.json();
        }).then(function(playerObj) {

            $('#playerStats').append("<tr><td><a href='player.html?player=" + playerObj.name + "'>" + playerObj.name + "</a></td>" +
                "<td>" + playerObj.flopPct + "</td>" +
                "<td>" + playerObj.vpip + "</td>" +
                "<td>" + playerObj.pfr + "</td>" +
                "<td>" + playerObj.aggressionFactor + "</td>" +
                "<td>" + playerObj.wentToShowdownPct + "</td>" +
                "</tr>");

            activeTimesChart.data.datasets.push(
                {
                    label: playerObj.name,
                        backgroundColor: colors.pop(),
                    data: Object.values(playerObj.hours)    ,
                }
            );
            activeTimesChart.update();
        });
    });


    function getFoldPercentage(actionsObject, actionType)
    {
        var folds = 0;
        var total = 0;
        Object.keys(actionsObject[actionType]).forEach(function(key) {
            switch (key) {
                case 'folds':
                    folds += actionsObject[actionType][key];
                case 'checks':
                case 'bets':
                case 'calls':
                case 'raises':
                    total += actionsObject[actionType][key];
                    break;
            }
        });

        return parseFloat((folds/total) * 100).toFixed(2)+"%";
    }

    fetch('allPlayers.php').then(function(res) {
        return res.json();
    }).then(function(playerObj) {


        var itemsProcessed = 0;
        playerObj.forEach(function(name) {
            $('#allPlayers').append($('<option>', { value : name })
                .text(name));

            itemsProcessed++;
            if(itemsProcessed === playerObj.length) {

                $('#allPlayers').val(players);
                $('#allPlayers').chosen();
            }
        });



    });

    $('#playerSearchForm').on('submit', function(e) {
        e.preventDefault();

        var selMulti = $.map($("#allPlayers option:selected"), function (el, i) {
            return $(el).text();
        });

        if (selMulti.length > 1) {
            window.location = 'table.html?players=' + selMulti.join(",");
        }
        else {
            window.location = 'player.html?player=' + selMulti[0];
        }
    });


</script>
</body>
</html>
