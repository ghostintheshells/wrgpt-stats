<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Player</title>

    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap-grid.min.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap-reboot.min.css">

    <link rel="stylesheet" href="node_modules/chosen-jquery/lib/chosen.min.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">WRGPT Stats</a>
    <form class="form-inline my-2 my-lg-0" role="search" id="playerSearchForm">
        <div class="form-group">
            <select class="form-control mr-sm-2" id="allPlayers" multiple name="players"></select>
        </div>
        <button type="submit" class="btn btn-outline-success my-2 my-sm-0">Submit</button>
    </form>
</nav>

<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Home</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="stats-tab" data-toggle="tab" href="#stats" role="tab" aria-controls="profile" aria-selected="false">Stats</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos1-tab" data-toggle="tab" href="#pos1" role="tab" aria-controls="profile" aria-selected="false">Small Blind</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos2-tab" data-toggle="tab" href="#pos2" role="tab" aria-controls="profile" aria-selected="false">Big Blind</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos3-tab" data-toggle="tab" href="#pos3" role="tab" aria-controls="profile" aria-selected="false">Seat 3</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos4-tab" data-toggle="tab" href="#pos4" role="tab" aria-controls="profile" aria-selected="false">Seat 4</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos5-tab" data-toggle="tab" href="#pos5" role="tab" aria-controls="profile" aria-selected="false">Seat 5</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos6-tab" data-toggle="tab" href="#pos6" role="tab" aria-controls="profile" aria-selected="false">Seat 6</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos7-tab" data-toggle="tab" href="#pos7" role="tab" aria-controls="profile" aria-selected="false">Seat 7</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos8-tab" data-toggle="tab" href="#pos8" role="tab" aria-controls="profile" aria-selected="false">Seat 8</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pos9-tab" data-toggle="tab" href="#pos9" role="tab" aria-controls="profile" aria-selected="false">Button</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="times-tab" data-toggle="tab" href="#times" role="tab" aria-controls="contact" aria-selected="false">Times</a>
    </li>
</ul>

<div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
        <div class="container-fluid">
            <table class="table">
                <tr><td>Tournaments</td><td><span id="playerTournaments"></span></td></tr>
                <tr><td>Tables</td><td><span id="playerTables"></span></td></tr>
                <tr><td>Cards</td><td><span id="playerCards"></span></td></tr>
                <tr><td>First Action</td><td><span id="firstAction"></span></td></tr>
                <tr><td>Last Action</td><td><span id="lastAction"></span></td></tr>
                <tr><td>Min Multiplier</td><td><span id="minMult"></span></td></tr>
                <tr><td>Max Multiplier</td><td><span id="maxMult"></span></td></tr>
                <tr><td>Avg Multiplier</td><td><span id="avgMult"></span></td></tr>
            </table>
        </div>
    </div>
    <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Pct to see flop</td><td><span id="pctFlop"></span></td></tr>
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange"></span></td></tr>
            <tr><td>Aggression Factor</td><td><span id="aggFactor"></span></td></tr>
            <tr><td>Showdown (after flop) %</td><td><span id="wtsd"></span></td></tr>
            <tr><td>Preflops</td><td><span id="preflopRoundCount"></span></td></tr>
            <tr><td>Flops</td><td><span id="flopRoundCount"></span></td></tr>
            <tr><td>Turns</td><td><span id="turnRoundCount"></span></td></tr>
            <tr><td>Rivers</td><td><span id="riverRoundCount"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos1" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_1"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_1"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_1"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_1"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos2" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_2"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_2"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_2"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_2"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos3" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_3"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_3"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_3"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_3"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos4" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_4"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_4"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_4"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_4"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos5" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_5"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_5"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_5"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_5"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos6" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_6"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_6"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_6"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_6"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos7" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_7"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_7"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_7"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_7"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos8" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_8"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_8"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_8"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_8"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="pos9" role="tabpanel" aria-labelledby="stats-tab">
        <table class="table">
            <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip_9"></span></td></tr>
            <tr><td>Pre-flop Raise %</td><td><span id="pfr_9"></span></td></tr>
            <tr><td>Player Type</td><td><span id="classification_9"></span></td></tr>
            <tr><td>Possible Range of Cards</td><td><span id="cardRange_9"></span></td></tr>
        </table>
    </div>
    <div class="tab-pane fade" id="times" role="tabpanel" aria-labelledby="times-tab">
        <div class="col-md-3">
            <h3>Times Active</h3>
            <canvas id="activeTimesChart" width="100" height="100"></canvas>
        </div>
    </div>
</div>

<!--<div class="container-fluid">
    <div class="row">

        <div class="col-md-3">
            <table class="table">
                <tr><td>Total Fold %</td><td><span id="allFoldPct"></span></td></tr>
                <tr><td>Preflop Fold %</td><td><span id="preflopFoldPct"></span></td></tr>
                <tr><td>Flop Fold %</td><td><span id="flopFoldPct"></span></td></tr>
                <tr><td>Turn Fold %</td><td><span id="turnFoldPct"></span></td></tr>
                <tr><td>River Fold %</td><td><span id="riverFoldPct"></span></td></tr>
            </table>
        </div>
        <div class="col-md-3">
            <table class="table">
                <tr><td>Pct to see flop</td><td><span id="pctFlop"></span></td></tr>
                <tr><td>Voluntary Put Money In Pot %</td><td><span id="vpip"></span></td></tr>
                <tr><td>Pre-flop Raise %</td><td><span id="pfr"></span></td></tr>
                <tr><td>Player Type</td><td><span id="classification"></span></td></tr>
                <tr><td>Possible Range of Cards</td><td><span id="cardRange"></span></td></tr>
                <tr><td>Aggression Factor</td><td><span id="aggFactor"></span></td></tr>
                <tr><td>Showdown (after flop) %</td><td><span id="wtsd"></span></td></tr>
                <tr><td>Preflops</td><td><span id="preflopRoundCount"></span></td></tr>
                <tr><td>Flops</td><td><span id="flopRoundCount"></span></td></tr>
                <tr><td>Turns</td><td><span id="turnRoundCount"></span></td></tr>
                <tr><td>Rivers</td><td><span id="riverRoundCount"></span></td></tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <h3>Times Active</h3>
            <canvas id="activeTimesChart" width="400" height="400"></canvas>
        </div>
        <div class="col-md-4">
            <h3>Total</h3>
            <canvas id="allActionsChart" width="200" height="200"></canvas>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">Preflop
            <canvas id="preflopActionsChart" width="200" height="200"></canvas>
        </div>
        <div class="col-md-3">Flop
            <canvas id="flopActionsChart" width="200" height="200"></canvas>
        </div>
        <div class="col-md-3">Turn
            <canvas id="turnActionsChart" width="200" height="200"></canvas>
        </div>
        <div class="col-md-3">River
            <canvas id="riverActionsChart" width="200" height="200"></canvas>
        </div>
    </div>
</div>-->

<script src="node_modules/jquery/dist/jquery.min.js"></script>
<script src="node_modules/chosen-jquery/lib/chosen.jquery.min.js"></script>
<script src="node_modules/chart.js/dist/Chart.bundle.min.js"></script>
<script src="node_modules/chartjs-plugin-labels/build/chartjs-plugin-labels.min.js"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script>

    const query = new URLSearchParams(location.search);

    fetch('player.php?player=' + query.get('player')).then(function(res) {
        return res.json();
    }).then(function(playerObj) {
       console.log(playerObj);
       console.log(playerObj.hours);

        document.getElementById('firstAction').innerText = playerObj.firstAction;
        document.getElementById('lastAction').innerText = playerObj.lastAction;
        document.getElementById('minMult').innerText = playerObj.multipliers['minMult'];
        document.getElementById('maxMult').innerText = playerObj.multipliers['maxMult'];
        document.getElementById('avgMult').innerText = playerObj.multipliers['avgMult'];
        document.getElementById('playerTournaments').innerText = playerObj.tournaments.join(', ');
        document.getElementById('playerTables').innerText = playerObj.tables.join(', ');
        document.getElementById('playerCards').innerHTML = playerObj.cards.join(', ');
        document.getElementById('allPlayers').value = playerObj.name;
        $('#allPlayers').trigger("chosen:updated");


        // document.getElementById('allFoldPct').innerText = getFoldPercentage(playerObj.actions, 'all');
        // document.getElementById('preflopFoldPct').innerText = getFoldPercentage(playerObj.actions, 'preflop');
        // document.getElementById('flopFoldPct').innerText = getFoldPercentage(playerObj.actions, 'flop');
        // document.getElementById('turnFoldPct').innerText = getFoldPercentage(playerObj.actions, 'turn');
        // document.getElementById('riverFoldPct').innerText = getFoldPercentage(playerObj.actions, 'river');


        document.getElementById('pctFlop').innerText = playerObj.flopPct;
        document.getElementById('vpip').innerText = playerObj.vpip;
        document.getElementById('pfr').innerText = playerObj.pfr;
        document.getElementById('classification').innerText = playerObj.classification;
        document.getElementById('cardRange').innerText = playerObj.range;
        document.getElementById('aggFactor').innerText = playerObj.aggressionFactor;
        document.getElementById('wtsd').innerText = playerObj.wentToShowdownPct;
        document.getElementById('preflopRoundCount').innerText = playerObj.rounds['preflop'];
        document.getElementById('flopRoundCount').innerText = playerObj.rounds['flop'];
        document.getElementById('turnRoundCount').innerText = playerObj.rounds['turn'];
        document.getElementById('riverRoundCount').innerText = playerObj.rounds['river'];

        var ctx = document.getElementById("activeTimesChart").getContext('2d');
        var activeTimesChart = new Chart(ctx, {
            type: 'radar',
            data : {
                labels: Object.keys(playerObj.hours),
                datasets: [{
                    label: playerObj.name,
                    backgroundColor: "rgba(200,0,0,0.2)",
                    data: Object.values(playerObj.hours)    ,
                }]
            },
        });

        for (var i = 1; i < 10; i++)
        {
            document.getElementById('vpip_' + i).innerText = playerObj.position[i].vpip;
            document.getElementById('pfr_' + i).innerText = playerObj.position[i].pfr;
            document.getElementById('classification_' + i).innerText = playerObj.position[i].classification;
            document.getElementById('cardRange_' + i).innerText = playerObj.position[i].range;
        }

        displayActionsChart(playerObj.actions, 'all', 'allActionsChart');
        displayActionsChart(playerObj.actions, 'preflop', 'preflopActionsChart');
        displayActionsChart(playerObj.actions, 'flop', 'flopActionsChart');
        displayActionsChart(playerObj.actions, 'turn', 'turnActionsChart');
        displayActionsChart(playerObj.actions, 'river', 'riverActionsChart');
    });

    function getFoldPercentage(actionsObject, actionType)
    {
        var folds = 0;
        var total = 0;
        Object.keys(actionsObject[actionType]).forEach(function(key) {
            switch (key) {
                case 'folds':
                    folds += actionsObject[actionType][key];
                case 'checks':
                case 'bets':
                case 'calls':
                case 'raises':
                case 'reraises':
                    total += actionsObject[actionType][key];
                    break;
            }
        });

        return parseFloat((folds/total) * 100).toFixed(2)+"%";
    }

    function displayActionsChart(actionsObject, actionType, ctxId) {
        var ctx = document.getElementById(ctxId).getContext('2d');
        var actionsChart = new Chart(ctx, {
            type: 'doughnut',
            plugins: {
                labels: [
                    {
                        render: 'label',
                        position: 'outside'
                    },
                    {
                        render: 'percentage',
                        precision: 2
                    },

                ]
            },
            data : {
                labels: Object.keys(actionsObject[actionType]),
                datasets: [{
                    label: "jasong",
                    backgroundColor: [
                        "rgba(100,0,0,0.2)",
                        "rgba(200,0,0,0.2)",
                        "rgba(0,100,0,0.2)",
                        "rgba(0,200,0,0.2)",
                        "rgba(0,0,100,0.2)",
                        "rgba(100,0,100,0.2)",
                    ],
                    data: Object.values(actionsObject[actionType]),
                }]
            },
        });
    };

    fetch('allPlayers.php').then(function(res) {
        return res.json();
    }).then(function(playerObj) {


        var itemsProcessed = 0;
        playerObj.forEach(function(name) {
            $('#allPlayers').append($('<option>', { value : name })
                .text(name));

            itemsProcessed++;
            if(itemsProcessed === playerObj.length) {
                $('#allPlayers').chosen();
            }
        });



    });

    $('#playerSearchForm').on('submit', function(e) {
        e.preventDefault();

        var selMulti = $.map($("#allPlayers option:selected"), function (el, i) {
            return $(el).text();
        });

        if (selMulti.length > 1) {
            window.location = 'table.html?players=' + selMulti.join(",");
        }
        else {
            window.location = 'player.html?player=' + selMulti[0];
        }
    });
</script>
</body>
</html>
